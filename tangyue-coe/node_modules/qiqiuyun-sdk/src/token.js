const crypto = require('crypto');

const rand_text = (length) => {
  let str = ''
  const options = '0123456789qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM';
  for (let i = 0; i < length; i ++) {
    str += options[~~(Math.random() * 62)];
  }
  return str;
}

const safeChar = {
  '+': '-',
  '/': '_'
}

const generateToken = (resNo, secretKey) => {
  const once = rand_text(16);
  const deadline = ~~(Date.now() / 1000 + 500);
  const signingText = `${resNo}\n${once}\n${deadline}`;
  const sign = crypto.createHmac('sha1', secretKey).update(signingText).digest();
  const encodedSign = sign.toString('base64').replace(/(\+|\/)/g, (res) => {
    return safeChar[res];
  });
  const playToken = `${once}:${deadline}:${encodedSign}`;
  return playToken;
}


module.exports = generateToken;